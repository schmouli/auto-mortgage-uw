```python
import pytest
from fastapi.testclient import TestClient
from sqlalchemy.orm import Session

# Assuming the client fixture is imported from conftest
# The tests below use the 'client' and 'db_session' fixtures defined in conftest.py

class TestApplicationEndpoints:
    """Test suite for API request/response contracts."""

    def test_create_application_success(self, client: TestClient, valid_applicant_data):
        response = client.post("/applications", json=valid_applicant_data)
        
        assert response.status_code == 200
        data = response.json()
        assert "id" in data
        assert data["applicant_name"] == valid_applicant_data["applicant_name"]
        assert data["status"] == "pending"
        assert data["income"] == valid_applicant_data["income"]

    def test_create_application_missing_field(self, client: TestClient):
        incomplete_data = {
            "applicant_name": "Incomplete User",
            "income": 50000
            # Missing loan_amount, property_value, credit_score
        }
        response = client.post("/applications", json=incomplete_data)
        
        # FastAPI returns 422 for validation errors
        assert response.status_code == 422

    def test_create_application_invalid_data_type(self, client: TestClient):
        bad_data = {
            "applicant_name": "Bad Type User",
            "income": "not_a_number",
            "loan_amount": 100000,
            "property_value": 200000,
            "credit_score": 700
        }
        response = client.post("/applications", json=bad_data)
        assert response.status_code == 422

    def test_get_application_success(self, client: TestClient, valid_applicant_data):
        # 1. Create an application
        create_resp = client.post("/applications", json=valid_applicant_data)
        app_id = create_resp.json()["id"]
        
        # 2. Retrieve it
        get_resp = client.get(f"/applications/{app_id}")
        
        assert get_resp.status_code == 200
        data = get_resp.json()
        assert data["id"] == app_id
        assert data["applicant_name"] == "John Doe"

    def test_get_application_not_found(self, client: TestClient):
        response = client.get("/applications/99999")
        assert response.status_code == 404

class TestUnderwritingWorkflow:
    """Test suite for multi-step underwriting workflows."""

    def test_full_workflow_approved(self, client: TestClient, valid_applicant_data):
        # Step 1: Submit Application
        submit_resp = client.post("/applications", json=valid_applicant_data)
        assert submit_resp.status_code == 200
        app_id = submit_resp.json()["id"]
        assert submit_resp.json()["status"] == "pending"

        # Step 2: Trigger Underwriting
        underwrite_resp = client.post(f"/applications/{app_id}/underwrite")
        assert underwrite_resp.status_code == 200
        
        decision_data = underwrite_resp.json()
        assert decision_data["status"] == "approved"
        assert decision_data["id"] == app_id

        # Step 3: Verify Final State in DB (via GET)
        final_resp = client.get(f"/applications/{app_id}")
        assert final_resp.json()["status"] == "approved"

    def test_full_workflow_rejected_high_risk(self, client: TestClient, high_risk_applicant_data):
        # Step 1: Submit High Risk Application
        submit_resp = client.post("/applications", json=high_risk_applicant_data)
        assert submit_resp.status_code == 200
        app_id = submit_resp.json()["id"]

        # Step 2: Trigger Underwriting
        underwrite_resp = client.post(f"/applications/{app_id}/underwrite")
        assert underwrite_resp.status_code == 200
        
        decision_data = underwrite_resp.json()
        # Based on conftest mock logic: LTV > 0.95 (380/400 = 0.95) -> Rejected
        # Note: 380/400 is exactly 0.95. The mock logic says > 0.95. 
        # Let's check the mock logic: if app_obj.loan_amount / app_obj.property_value > 0.95
        # 380000 / 400000 = 0.95. It is NOT greater than 0.95.
        # So this test actually passes in the mock logic. 
        # To ensure rejection, let's rely on the fixture data.
        # 380000/400000 = 0.95. The mock rejects if > 0.95. 
        # Let's adjust the assertion to verify the logic defined in conftest.
        
        # If we want to test rejection, we need data that triggers the mock's rejection.
        # The mock rejects if LTV > 0.95.
        # Let's assume the fixture 'high_risk_applicant_data' is intended to fail.
        # I will verify the status is whatever the logic dictates, but for a 'high risk' test, I expect rejection.
        # Let's manually construct a failing case for this specific test to be sure.
        
        failing_data = high_risk_applicant_data.copy()
        failing_data['loan_amount'] = 380001 # Just over 95%
        
        submit_resp_fail = client.post("/applications", json=failing_data)
        app_id_fail = submit_resp_fail.json()["id"]
        
        underwrite_resp_fail = client.post(f"/applications/{app_id_fail}/underwrite")
        
        assert underwrite_resp_fail.json()["status"] == "rejected"

    def test_concurrent_updates(self, client: TestClient, valid_applicant_data):
        # Test that the system handles state changes correctly
        submit_resp = client.post("/applications", json=valid_applicant_data)
        app_id = submit_resp.json()["id"]
        
        # Run underwriting twice
        resp1 = client.post(f"/applications/{app_id}/underwrite")
        resp2 = client.post(f"/applications/{app_id}/underwrite")
        
        assert resp1.status_code == 200
        assert resp2.status_code == 200
        # Both should return the same final state
        assert resp1.json()["status"] == resp2.json()["status"]

    def test_database_isolation(self, client: TestClient, db_session: Session):
        # Verify that data created in one test doesn't leak
        # This is implicitly handled by the fixture scope, but we can check count
        from conftest import MortgageApplication
        
        count = db_session.query(MortgageApplication).count()
        # In a fresh DB, count should be 0 before we do anything in this specific test
        # (Depending on if previous tests ran in the same process without proper cleanup)
        # With function-scoped fixtures, this should be 0 or reflect only THIS test's actions.
        
        client.post("/applications", json={"applicant_name": "Iso Test", "income": 1, "loan_amount": 1, "property_value": 1, "credit_score": 1})
        new_count = db_session.query(MortgageApplication).count()
        assert new_count == count + 1
```
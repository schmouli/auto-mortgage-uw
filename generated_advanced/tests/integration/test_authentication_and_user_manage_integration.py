```python
import pytest
from fastapi.testclient import TestClient

# Hypothetical imports
# from app.api.v1.endpoints.auth import router as auth_router
# from app.db.session import get_db

# Register routes in conftest or main app setup
# app.include_router(auth_router, prefix="/api/v1/auth", tags=["auth"])

class TestAuthEndpoints:
    """Integration tests for Authentication API endpoints."""
    
    def test_register_user_creates_user_and_returns_201(self, client: TestClient, valid_user_data):
        """
        Test the user registration endpoint.
        """
        # Mocking the DB dependency behavior inside the route is handled by the 'client' fixture 
        # which we assume overrides the DB session. 
        # However, for a true integration test without mocking the route logic, we rely on the app state.
        # Since we don't have the real app, we simulate the request expectations.
        
        response = client.post("/api/v1/auth/register", json=valid_user_data)
        
        # Assertions
        # Assuming successful creation returns 201 Created
        # assert response.status_code == 201 
        
        # For this mock environment, we check the contract
        assert response.status_code in [201, 200] # Allow 200 if implementation differs
        json_data = response.json()
        assert "id" in json_data or "email" in json_data
        assert json_data.get("email") == valid_user_data["email"]
        assert "password" not in json_data # Ensure password is not returned in response

    def test_register_user_with_invalid_email_returns_422(self, client: TestClient):
        """
        Test validation error for bad email format.
        """
        invalid_data = {
            "email": "not-an-email",
            "password": "password123",
            "full_name": "Test User"
        }
        
        response = client.post("/api/v1/auth/register", json=invalid_data)
        
        assert response.status_code == 422
        assert "detail" in response.json()

    def test_register_user_with_weak_password_returns_400(self, client: TestClient):
        """
        Test business logic validation for weak password (e.g., < 8 chars).
        """
        weak_data = {
            "email": "test@onlendhub.ca",
            "password": "123", # Weak
            "full_name": "Test User"
        }
        
        response = client.post("/api/v1/auth/register", json=weak_data)
        
        assert response.status_code == 400 or response.status_code == 422

    def test_login_returns_jwt_token(self, client: TestClient, valid_user_data):
        """
        Test the login endpoint returns a valid access token.
        """
        # Step 1: Register (Setup)
        client.post("/api/v1/auth/register", json=valid_user_data)
        
        # Step 2: Login
        login_data = {
            "username": valid_user_data["email"], 
            "password": valid_user_data["password"]
        }
        response = client.post("/api/v1/auth/token", data=login_data)
        
        # Assertions
        assert response.status_code == 200
        json_data = response.json()
        assert "access_token" in json_data
        assert json_data["token_type"] == "bearer"

    def test_login_with_invalid_credentials_returns_401(self, client: TestClient):
        """
        Test login failure with wrong password.
        """
        login_data = {
            "username": "unknown@onlendhub.ca",
            "password": "wrongpassword"
        }
        response = client.post("/api/v1/auth/token", data=login_data)
        
        assert response.status_code == 401
        assert "detail" in response.json()

    def test_protected_endpoint_without_token_returns_401(self, client: TestClient):
        """
        Test accessing a protected route without authentication header.
        """
        response = client.get("/api/v1/users/me")
        
        assert response.status_code == 401

    def test_protected_endpoint_with_valid_token_returns_200(self, client: TestClient, valid_user_data):
        """
        Test accessing a protected route with a valid Bearer token.
        """
        # 1. Setup: Register and Login to get token
        client.post("/api/v1/auth/register", json=valid_user_data)
        login_res = client.post("/api/v1/auth/token", data={
            "username": valid_user_data["email"],
            "password": valid_user_data["password"]
        })
        token = login_res.json().get("access_token")
        
        # 2. Act: Access protected endpoint
        headers = {"Authorization": f"Bearer {token}"}
        response = client.get("/api/v1/users/me", headers=headers)
        
        # 3. Assert
        assert response.status_code == 200
        user_data = response.json()
        assert user_data["email"] == valid_user_data["email"]

    def test_update_user_profile_workflow(self, client: TestClient, valid_user_data):
        """
        Multi-step workflow: Register -> Login -> Update Profile -> Verify.
        """
        # 1. Register
        client.post("/api/v1/auth/register", json=valid_user_data)
        
        # 2. Login
        login_res = client.post("/api/v1/auth/token", data={
            "username": valid_user_data["email"],
            "password": valid_user_data["password"]
        })
        token = login_res.json().get("access_token")
        headers = {"Authorization": f"Bearer {token}"}
        
        # 3. Update Profile
        update_payload = {"full_name": "Sarah Jenkins-Updated"}
        update_res = client.put("/api/v1/users/me", json=update_payload, headers=headers)
        
        assert update_res.status_code == 200
        assert update_res.json()["full_name"] == "Sarah Jenkins-Updated"
        
        # 4. Verify Update (Get Me)
        get_res = client.get("/api/v1/users/me", headers=headers)
        assert get_res.json()["full_name"] == "Sarah Jenkins-Updated"

    def test_logout_token_blacklist(self, client: TestClient, valid_user_data):
        """
        Test logout functionality (if blacklist is implemented).
        """
        # Setup
        client.post("/api/v1/auth/register", json=valid_user_data)
        login_res = client.post("/api/v1/auth/token", data={
            "username": valid_user_data["email"],
            "password": valid_user_data["password"]
        })
        token = login_res.json().get("access_token")
        headers = {"Authorization": f"Bearer {token}"}
        
        # Logout (Assuming endpoint exists)
        logout_res = client.post("/api/v1/auth/logout", headers=headers)
        assert logout_res.status_code == 200
        
        # Try to use token again
        me_res = client.get("/api/v1/users/me", headers=headers)
        # Expecting 401 if token is invalidated/blacklisted
        # If using simple JWT exp without blacklist, this might return 200. 
        # Assuming robust security implementation:
        assert me_res.status_code == 401 
```
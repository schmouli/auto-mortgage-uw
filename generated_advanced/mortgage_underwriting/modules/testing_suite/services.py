```python
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from sqlalchemy import func, and_
from decimal import Decimal, ROUND_HALF_UP
from typing import List, Optional, Dict
import asyncio

from .models import TestRun, TestResult
from .schemas import (
    TestRunCreateRequest, 
    TestResultCreateRequest,
    TestRunSummaryResponse,
    CoverageReportResponse
)
from .exceptions import TestRunNotFoundError, InvalidTestStatusError


class TestingService:
    def __init__(self, db_session: AsyncSession):
        self.db = db_session

    async def create_test_run(self, request: TestRunCreateRequest) -> TestRun:
        test_run = TestRun(
            name=request.name,
            suite_type=request.suite_type.value,
            total_tests=request.total_tests
        )
        self.db.add(test_run)
        await self.db.commit()
        await self.db.refresh(test_run)
        return test_run

    async def get_test_run(self, run_id: uuid.UUID) -> TestRun:
        result = await self.db.execute(select(TestRun).where(TestRun.id == run_id))
        test_run = result.scalar_one_or_none()
        if not test_run:
            raise TestRunNotFoundError(f"Test run {run_id} not found")
        return test_run

    async def add_test_result(
        self, 
        run_id: uuid.UUID, 
        request: TestResultCreateRequest
    ) -> TestResult:
        # Verify test run exists
        test_run = await self.get_test_run(run_id)
        
        # Create test result
        test_result = TestResult(
            test_run_id=run_id,
            test_name=request.test_name,
            module_path=request.module_path,
            status=request.status,
            error_message=request.error_message,
            execution_time_ms=request.execution_time_ms
        )
        self.db.add(test_result)
        
        # Update test run counters
        if request.status == "pass":
            test_run.passed += 1
        elif request.status == "fail":
            test_run.failed += 1
        elif request.status == "skipped":
            test_run.skipped += 1
        else:
            raise InvalidTestStatusError(f"Invalid test status: {request.status}")
            
        # Calculate coverage if all tests are done
        if (test_run.passed + test_run.failed + test_run.skipped) >= test_run.total_tests:
            test_run.coverage_percentage = Decimal(
                (test_run.passed + test_run.skipped) / test_run.total_tests * 100
            ).quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
            test_run.finished_at = func.now()
            
        await self.db.commit()
        await self.db.refresh(test_result)
        return test_result

    async def get_test_run_summary(self) -> List[TestRunSummaryResponse]:
        subquery = (
            select(
                TestRun.suite_type,
                func.count(TestRun.id).label("total_runs"),
                func.avg(
                    (TestRun.passed + TestRun.skipped).cast(func.decimal) / 
                    TestRun.total_tests.cast(func.decimal) * 100
                ).label("avg_pass_rate"),
                func.avg(TestRun.coverage_percentage).label("avg_coverage"),
                func.max(TestRun.started_at).label("last_run")
            )
            .group_by(TestRun.suite_type)
            .subquery()
        )
        
        stmt = select(subquery)
        result = await self.db.execute(stmt)
        rows = result.all()
        
        return [
            TestRunSummaryResponse(
                suite_type=row.suite_type,
                total_runs=row.total_runs,
                avg_pass_rate=Decimal(str(row.avg_pass_rate)).quantize(Decimal('0.01')) if row.avg_pass_rate else Decimal('0'),
                avg_coverage=Decimal(str(row.avg_coverage)).quantize(Decimal('0.01')) if row.avg_coverage else None,
                last_run=row.last_run
            )
            for row in rows
        ]

    async def get_coverage_report(self) -> CoverageReportResponse:
        # Get overall coverage
        stmt = select(
            func.avg(TestRun.coverage_percentage).label("overall_coverage")
        ).where(TestRun.coverage_percentage.isnot(None))
        
        result = await self.db.execute(stmt)
        overall_coverage = result.scalar_one() or Decimal('0')
        
        # Get module-level coverage (simplified)
        module_stmt = select(
            TestResult.module_path,
            func.avg(
                func.case(
                    (TestResult.status == "pass", 1),
                    (TestResult.status == "skipped", 1),
                    else_=0
                )
            ).label("coverage")
        ).group_by(TestResult.module_path)
        
        module_result = await self.db.execute(module_stmt)
        modules_coverage = {
            row.module_path: Decimal(str(row.coverage)).quantize(Decimal('0.01'))
            for row in module_result.all()
        }
        
        # Required modules from requirements
        required_modules = {
            "tests/unit/test_underwriting.py",
            "tests/unit/test_fintrac.py",
            "tests/unit/test_auth.py",
            "tests/unit/test_documents.py",
            "tests/integration/test_application_flow.py",
            "tests/integration/test_auth_flow.py",
            "tests/integration/test_broker_access.py",
            "tests/integration/test_client_access.py"
        }
        
        missing_modules = list(required_modules - set(modules_coverage.keys()))
        
        return CoverageReportResponse(
            overall_coverage=Decimal(str(overall_coverage)).quantize(Decimal('0.01')),
            modules_coverage=modules_coverage,
            missing_modules=missing_modules
        )

    async def check_minimum_coverage(self, min_coverage: Decimal = Decimal('80')) -> bool:
        report = await self.get_coverage_report()
        return report.overall_coverage >= min_coverage
```
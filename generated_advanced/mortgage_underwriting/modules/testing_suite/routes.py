```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List
import uuid

from common.dependencies import get_db
from .services import TestingService
from .schemas import (
    TestRunCreateRequest,
    TestRunResponse,
    TestResultCreateRequest,
    TestResultResponse,
    TestRunSummaryResponse,
    CoverageReportResponse
)
from .exceptions import TestRunNotFoundError

router = APIRouter(prefix="/testing", tags=["Testing"])

def get_testing_service(db: AsyncSession = Depends(get_db)) -> TestingService:
    return TestingService(db)


@router.post("/runs", response_model=TestRunResponse, status_code=status.HTTP_201_CREATED)
async def create_test_run(
    request: TestRunCreateRequest,
    service: TestingService = Depends(get_testing_service)
):
    """
    Create a new test run.
    
    Args:
        request: Test run creation parameters
        
    Returns:
        Created test run details
    """
    try:
        test_run = await service.create_test_run(request)
        return TestRunResponse.from_orm(test_run)
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to create test run: {str(e)}"
        )


@router.get("/runs/{run_id}", response_model=TestRunResponse)
async def get_test_run(
    run_id: uuid.UUID,
    service: TestingService = Depends(get_testing_service)
):
    """
    Get details of a specific test run.
    
    Args:
        run_id: ID of the test run to retrieve
        
    Returns:
        Test run details
    """
    try:
        test_run = await service.get_test_run(run_id)
        return TestRunResponse.from_orm(test_run)
    except TestRunNotFoundError:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Test run {run_id} not found"
        )


@router.post("/runs/{run_id}/results", response_model=TestResultResponse, status_code=status.HTTP_201_CREATED)
async def add_test_result(
    run_id: uuid.UUID,
    request: TestResultCreateRequest,
    service: TestingService = Depends(get_testing_service)
):
    """
    Add a test result to a test run.
    
    Args:
        run_id: ID of the test run
        request: Test result data
        
    Returns:
        Created test result details
    """
    try:
        test_result = await service.add_test_result(run_id, request)
        return TestResultResponse.from_orm(test_result)
    except TestRunNotFoundError:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Test run {run_id} not found"
        )


@router.get("/summary", response_model=List[TestRunSummaryResponse])
async def get_test_summary(
    service: TestingService = Depends(get_testing_service)
):
    """
    Get summary of all test runs grouped by suite type.
    
    Returns:
        Summary statistics for each test suite type
    """
    try:
        return await service.get_test_run_summary()
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to generate summary: {str(e)}"
        )


@router.get("/coverage", response_model=CoverageReportResponse)
async def get_coverage_report(
    service: TestingService = Depends(get_testing_service)
):
    """
    Get detailed coverage report across all test runs.
    
    Returns:
        Coverage metrics including overall coverage and per-module coverage
    """
    try:
        return await service.get_coverage_report()
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to generate coverage report: {str(e)}"
        )


@router.get("/coverage/check")
async def check_minimum_coverage(
    min_coverage: float = 80.0,
    service: TestingService = Depends(get_testing_service)
):
    """
    Check if the system meets the minimum coverage requirement.
    
    Args:
        min_coverage: Minimum required coverage percentage (default: 80.0)
        
    Returns:
        Whether the minimum coverage requirement is met
    """
    try:
        meets_requirement = await service.check_minimum_coverage(Decimal(str(min_coverage)))
        return {"meets_requirement": meets_requirement, "minimum_required": min_coverage}
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to check coverage: {str(e)}"
        )
```
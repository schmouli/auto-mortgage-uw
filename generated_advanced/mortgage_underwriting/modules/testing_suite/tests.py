Here are the comprehensive tests for the **Canadian Mortgage Underwriting System**, specifically targeting the **Testing Suite** (assumed to be the core business logic module responsible for rule evaluation and decisioning).

--- conftest.py ---
```python
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from typing import Generator, Dict, Any
from unittest.mock import MagicMock

# Assuming the main application file is named 'main.py'
# Import the actual app and DB base from your project structure
# from main import app, get_db, Base
# from models import MortgageApplication

# --- Mocks for imports to make this standalone runnable ---
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()
class MortgageApplication(BaseModel):
    id: int
    applicant_name: str
    loan_amount: float
    property_value: float
    credit_score: int
    annual_income: float
    annual_property_tax: float
    annual_heating: float
    other_debt: float

# --- Database Setup (In-Memory SQLite) ---
SQLALCHEMY_DATABASE_URL = "sqlite:///:memory:"
engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False})
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Dependency Override
def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()

# --- Fixtures ---

@pytest.fixture(scope="function")
def db_session() -> Generator[Session, None, None]:
    """
    Creates a fresh database session for each test.
    """
    # Create tables
    # Base.metadata.create_all(bind=engine) 
    # Note: In a real scenario, uncomment the line above to create actual tables.
    
    session = TestingSessionLocal()
    try:
        yield session
    finally:
        session.close()
        # Base.metadata.drop_all(bind=engine)

@pytest.fixture(scope="function")
def client(db_session: Session) -> TestClient:
    """
    Creates a TestClient that uses the override dependency for the DB.
    """
    # app.dependency_overrides[get_db] = override_get_db
    # with TestClient(app) as test_client:
    #     yield test_client
    # app.dependency_overrides.clear()
    
    # Standalone mock for demonstration
    from main import app
    return TestClient(app)

@pytest.fixture
def valid_applicant_data() -> Dict[str, Any]:
    """
    Returns a dictionary representing a valid Canadian mortgage applicant.
    """
    return {
        "applicant_name": "John Doe",
        "loan_amount": 400000.00,
        "property_value": 500000.00,
        "credit_score": 750,
        "annual_income": 120000.00,
        "annual_property_tax": 3000.00,
        "annual_heating": 1200.00,
        "other_debt": 500.00
    }

@pytest.fixture
def mock_bureau_service():
    """
    Mocks the external Credit Bureau service (e.g., Equifax/TransUnion).
    """
    with pytest.mock.patch('testing_suite.external_bureau.BureauService.get_score') as mock:
        yield mock

@pytest.fixture
def mock_property_valuation():
    """
    Mocks the external Property Valuation service.
    """
    with pytest.mock.patch('testing_suite.property_api.PropertyAPI.get_valuation') as mock:
        yield mock
```

--- unit_tests ---
```python
import pytest
from decimal import Decimal
from unittest.mock import patch, MagicMock

# Import the module under test
# from testing_suite import UnderwritingEngine, Calculator
# Assuming the module is named testing_suite.py

# --- Mock Module Implementation for Context ---
class Calculator:
    @staticmethod
    def calculate_ltv(loan_amount: float, property_value: float) -> float:
        if property_value <= 0: raise ValueError("Property value must be positive")
        return round((loan_amount / property_value) * 100, 2)

    @staticmethod
    def calculate_gds(mortgage_payment: float, property_tax: float, heating: float, income: float) -> float:
        if income <= 0: raise ValueError("Income must be positive")
        annual_housing = (mortgage_payment * 12) + property_tax + heating
        return round((annual_housing / income) * 100, 2)

    @staticmethod
    def calculate_tds(total_debt_monthly: float, income: float) -> float:
        if income <= 0: raise ValueError("Income must be positive")
        return round(((total_debt_monthly * 12) / income) * 100, 2)

class UnderwritingEngine:
    def __init__(self):
        self.min_credit_score = 600
        self.max_ltv = 95.0
        self.max_gds = 39.0
        self.max_tds = 44.0

    def evaluate_application(self, data: dict) -> dict:
        # Simplified logic for testing
        ltv = Calculator.calculate_ltv(data['loan_amount'], data['property_value'])
        
        # Mocking a mortgage payment calculation (approx 20% of loan for simplicity in unit test)
        est_mortgage_monthly = data['loan_amount'] * 0.005 
        
        gds = Calculator.calculate_gds(
            est_mortgage_monthly, 
            data['annual_property_tax'], 
            data['annual_heating'], 
            data['annual_income']
        )
        
        total_monthly_debt = est_mortgage_monthly + (data['annual_property_tax']/12) + (data['annual_heating']/12) + data['other_debt']
        tds = Calculator.calculate_tds(total_monthly_debt, data['annual_income'])

        decision = "APPROVED"
        reasons = []

        if data['credit_score'] < self.min_credit_score:
            decision = "REJECTED"
            reasons.append("Low Credit Score")
        
        if ltv > self.max_ltv:
            decision = "REFER" if decision == "APPROVED" else decision
            reasons.append("High LTV")
            
        if gds > self.max_gds:
            decision = "REFER" if decision == "APPROVED" else decision
            reasons.append("High GDS")

        if tds > self.max_tds:
            decision = "REFER" if decision == "APPROVED" else decision
            reasons.append("High TDS")

        return {
            "decision": decision,
            "ltv": ltv,
            "gds": gds,
            "tds": tds,
            "reasons": reasons
        }

# --- Unit Tests ---

class TestCalculator:
    """
    Unit tests for the Calculator helper functions.
    """
    def test_calculate_ltv_happy_path(self):
        result = Calculator.calculate_ltv(400000, 500000)
        assert result == 80.0
        assert isinstance(result, float)

    def test_calculate_ltv_high_ratio(self):
        # Test 95% LTV (CMHC insured threshold)
        result = Calculator.calculate_ltv(475000, 500000)
        assert result == 95.0

    def test_calculate_ltv_zero_value_error(self):
        with pytest.raises(ValueError) as excinfo:
            Calculator.calculate_ltv(100000, 0)
        assert "Property value must be positive" in str(excinfo.value)

    def test_calculate_gds_standard(self):
        # Income 100k, Housing 20k -> 20%
        result = Calculator.calculate_gds(1500, 2000, 1000, 100000)
        # (18000 + 2000 + 1000) / 100000 = 21%
        assert result == 21.0

    def test_calculate_gds_boundary(self):
        # Income 100k, Housing 39k -> 39% (Limit)
        result = Calculator.calculate_gds(3000, 2000, 1000, 100000)
        assert result == 39.0

    def test_calculate_gds_zero_income_error(self):
        with pytest.raises(ValueError):
            Calculator.calculate_gds(1000, 100, 100, 0)

    def test_calculate_tds_standard(self):
        # Debt 40k, Income 100k -> 40%
        result = Calculator.calculate_tds(3333.33, 100000)
        assert result == 40.0

    def test_calculate_tds_exact_boundary(self):
        # Debt 44k, Income 100k -> 44% (Limit)
        result = Calculator.calculate_tds(3666.66, 100000)
        assert round(result, 2) == 44.0

    def test_calculate_tds_exceeds_limit(self):
        # Debt 50k, Income 100k -> 50%
        result = Calculator.calculate_tds(4166.66, 100000)
        assert result > 44.0


class TestUnderwritingEngine:
    """
    Unit tests for the UnderwritingEngine logic.
    Mocks dependencies implicitly by using data dicts.
    """
    
    @pytest.fixture
    def engine(self):
        return UnderwritingEngine()

    def test_perfect_applicant_approval(self, engine):
        data = {
            "loan_amount": 300000,
            "property_value": 500000, # 60% LTV
            "credit_score": 800,
            "annual_income": 150000,
            "annual_property_tax": 3000,
            "annual_heating": 1200,
            "other_debt": 0
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "APPROVED"
        assert len(result["reasons"]) == 0
        assert result["ltv"] == 60.0

    def test_low_credit_score_rejection(self, engine):
        data = {
            "loan_amount": 100000,
            "property_value": 500000,
            "credit_score": 500, # Below 600
            "annual_income": 200000,
            "annual_property_tax": 1000,
            "annual_heating": 500,
            "other_debt": 0
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REJECTED"
        assert "Low Credit Score" in result["reasons"]

    def test_high_ltv_referral(self, engine):
        # 96% LTV (Above 95% limit)
        data = {
            "loan_amount": 480000,
            "property_value": 500000,
            "credit_score": 700,
            "annual_income": 200000,
            "annual_property_tax": 3000,
            "annual_heating": 1200,
            "other_debt": 0
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REFER"
        assert "High LTV" in result["reasons"]

    def test_high_gds_referral(self, engine):
        # Low income relative to housing costs
        data = {
            "loan_amount": 400000,
            "property_value": 500000,
            "credit_score": 700,
            "annual_income": 50000, # Low income
            "annual_property_tax": 5000,
            "annual_heating": 2000,
            "other_debt": 0
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REFER"
        assert "High GDS" in result["reasons"]

    def test_high_tds_referral(self, engine):
        # Significant other debt
        data = {
            "loan_amount": 300000,
            "property_value": 500000,
            "credit_score": 700,
            "annual_income": 80000,
            "annual_property_tax": 3000,
            "annual_heating": 1200,
            "other_debt": 3000 # High monthly debt
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REFER"
        assert "High TDS" in result["reasons"]

    def test_multiple_referral_reasons(self, engine):
        data = {
            "loan_amount": 480000, # High LTV
            "property_value": 500000,
            "credit_score": 700,
            "annual_income": 60000, # High GDS/TDS risk
            "annual_property_tax": 4000,
            "annual_heating": 1500,
            "other_debt": 1000
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REFER"
        assert len(result["reasons"]) >= 2
        assert "High LTV" in result["reasons"]

    def test_rejection_overrides_referral(self, engine):
        # If credit is bad, it should reject, not just refer for LTV
        data = {
            "loan_amount": 490000, # High LTV
            "property_value": 500000,
            "credit_score": 400, # Terrible credit
            "annual_income": 200000,
            "annual_property_tax": 3000,
            "annual_heating": 1200,
            "other_debt": 0
        }
        result = engine.evaluate_application(data)
        assert result["decision"] == "REJECTED"
        # Depending on logic implementation, it might list LTV too, but decision must be REJECT
        assert "Low Credit Score" in result["reasons"]

    @patch('testing_suite.Calculator.calculate_ltv')
    def test_external_dependency_failure_handling(self, mock_ltv, engine):
        # Test how engine handles calculation errors
        mock_ltv.side_effect = Exception("Database connection failed")
        data = {
            "loan_amount": 100000,
            "property_value": 200000,
            "credit_score": 700,
            "annual_income": 100000,
            "annual_property_tax": 2000,
            "annual_heating": 1000,
            "other_debt": 0
        }
        with pytest.raises(Exception):
            engine.evaluate_application(data)

    def test_calculator_precision_rounding(self):
        # Ensure rounding works correctly for currency
        ltv = Calculator.calculate_ltv(333333.33, 500000.00)
        assert ltv == 66.67
```

--- integration_tests ---
```python
import pytest
from fastapi import FastAPI, Depends
from sqlalchemy.orm import Session

# Assuming 'main.py' contains the FastAPI app setup
# from main import app

# --- Mock API Setup for Demonstration ---
app = FastAPI()

# Mock Database dependency
def get_db():
    pass 

@app.post("/api/v1/applications")
async def create_application(app_data: dict, db: Session = Depends(get_db)):
    return {"id": 1, "status": "SUBMITTED", **app_data}

@app.post("/api/v1/underwrite/{application_id}")
async def underwrite_application(application_id: int, db: Session = Depends(get_db)):
    # Simulate processing
    return {
        "application_id": application_id,
        "decision": "APPROVED",
        "ltv": 80.0,
        "gds": 25.0,
        "tds": 30.0,
        "timestamp": "2023-10-27T10:00:00Z"
    }

@app.get("/api/v1/applications/{application_id}")
async def get_application(application_id: int, db: Session = Depends(get_db)):
    return {
        "id": application_id,
        "status": "UNDERWRITTEN",
        "decision": "APPROVED"
    }

# --- Integration Tests ---

class TestMortgageAPI:
    """
    Integration tests for the Mortgage Underwriting API endpoints.
    Uses FastAPI TestClient to verify HTTP contracts and workflows.
    """

    def test_create_application_success(self, client: TestClient, valid_applicant_data):
        """
        Test the happy path of creating a new mortgage application.
        """
        response = client.post("/api/v1/applications", json=valid_applicant_data)
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "SUBMITTED"
        assert data["applicant_name"] == "John Doe"
        assert "id" in data
        assert isinstance(data["id"], int)

    def test_create_application_missing_field(self, client: TestClient):
        """
        Test validation error when required fields are missing.
        """
        invalid_data = {
            "applicant_name": "Jane Doe",
            # Missing loan_amount, property_value, etc.
        }
        response = client.post("/api/v1/applications", json=invalid_data)
        
        assert response.status_code == 422  # Unprocessable Entity for validation errors

    def test_create_application_invalid_data_type(self, client: TestClient, valid_applicant_data):
        """
        Test validation error with incorrect data types (e.g., string for loan amount).
        """
        invalid_data = valid_applicant_data.copy()
        invalid_data["loan_amount"] = "not_a_number"
        
        response = client.post("/api/v1/applications", json=invalid_data)
        assert response.status_code == 422

    def test_underwrite_workflow(self, client: TestClient, valid_applicant_data):
        """
        Multi-step workflow: Create Application -> Trigger Underwriting -> Verify Result.
        """
        # Step 1: Create
        create_resp = client.post("/api/v1/applications", json=valid_applicant_data)
        assert create_resp.status_code == 200
        app_id = create_resp.json()["id"]

        # Step 2: Underwrite
        underwrite_resp = client.post(f"/api/v1/underwrite/{app_id}")
        assert underwrite_resp.status_code == 200
        uw_data = underwrite_resp.json()
        
        assert uw_data["application_id"] == app_id
        assert "decision" in uw_data
        assert "ltv" in uw_data
        assert "timestamp" in uw_data

        # Step 3: Verify state change (mocked GET)
        get_resp = client.get(f"/api/v1/applications/{app_id}")
        assert get_resp.status_code == 200
        assert get_resp.json()["status"] == "UNDERWRITTEN"

    def test_underwrite_non_existent_application(self, client: TestClient):
        """
        Test handling of underwriting a non-existent ID.
        """
        response = client.post("/api/v1/underwrite/99999")
        # Assuming the API returns 404 for missing resources
        assert response.status_code == 404

    def test_get_application_not_found(self, client: TestClient):
        """
        Test retrieving an application that does not exist.
        """
        response = client.get("/api/v1/applications/99999")
        assert response.status_code == 404

    def test_api_response_headers(self, client: TestClient, valid_applicant_data):
        """
        Test that response headers contain correct content type.
        """
        response = client.post("/api/v1/applications", json=valid_applicant_data)
        assert "application/json" in response.headers["content-type"]

    def test_concurrent_request_handling(self, client: TestClient, valid_applicant_data):
        """
        Test that the API handles multiple requests (basic simulation).
        Note: Real concurrency testing requires asyncio or threading, 
        but this checks basic sequential integrity.
        """
        ids = []
        for _ in range(3):
            r = client.post("/api/v1/applications", json=valid_applicant_data)
            ids.append(r.json()["id"])
        
        # Verify all IDs are unique (simulated by logic)
        assert len(set(ids)) == 3

    def test_underwriting_response_contract(self, client: TestClient):
        """
        Verify the JSON structure of the underwriting response matches the contract.
        """
        # Setup: Create app manually or assume ID 1 exists
        response = client.post("/api/v1/underwrite/1")
        data = response.json()
        
        required_fields = ["application_id", "decision", "ltv", "gds", "tds", "timestamp"]
        for field in required_fields:
            assert field in data, f"Missing field: {field}"
        
        # Validate types
        assert isinstance(data["ltv"], float)
        assert isinstance(data["decision"], str)

    def test_invalid_http_method(self, client: TestClient):
        """
        Test that unsupported methods return 405 Method Not Allowed.
        """
        response = client.put("/api/v1/applications/1")
        assert response.status_code == 405
```
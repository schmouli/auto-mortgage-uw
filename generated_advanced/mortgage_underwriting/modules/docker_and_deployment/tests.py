Here are the comprehensive tests for the **Docker & Deployment** module of the Canadian Mortgage Underwriting System.

--- conftest.py ---
```python
import pytest
import os
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from unittest.mock import Mock, patch
import redis
from typing import Generator, Dict, Any

# Hypothetical imports for the project structure
# In a real scenario, these would import the actual app and models
# from main import app
# from database import Base, get_db
# from models import MortgageApplication

# --- Mocks for Project Structure ---

class Base:
    pass

class MortgageApplication(Base):
    __tablename__ = "applications"
    def __init__(self, id, applicant_name, amount):
        self.id = id
        self.applicant_name = applicant_name
        self.amount = amount

# --- Pytest Fixtures ---

@pytest.fixture(scope="function")
def db_engine():
    """Creates an in-memory SQLite database for testing."""
    engine = create_engine(
        "sqlite:///:memory:",
        connect_args={"check_same_thread": False},
        poolclass=StaticPool,
    )
    # Base.metadata.create_all(bind=engine) # Uncomment if models are real
    return engine

@pytest.fixture(scope="function")
def db_session(db_engine):
    """Creates a new database session for a test."""
    TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=db_engine)
    session = TestingSessionLocal()
    try:
        yield session
    finally:
        session.close()

@pytest.fixture(scope="function")
def mock_redis_client():
    """Mocks the Redis client used for caching."""
    with patch("redis.Redis") as mock_redis:
        instance = mock_redis.return_value
        instance.ping.return_value = True
        instance.get.return_value = None
        instance.set.return_value = True
        yield instance

@pytest.fixture(scope="function")
def mock_credit_bureau_api():
    """Mocks the external Credit Bureau API (Equifax/TransUnion)."""
    with patch("utils.external_clients.CreditBureauClient") as mock_cb:
        mock_cb.check_service_health.return_value = True
        yield mock_cb

@pytest.fixture(scope="function")
def sample_mortgage_payload() -> Dict[str, Any]:
    """Valid payload for a Canadian mortgage application."""
    return {
        "application_id": "APP-CA-2023-001",
        "applicant_name": "John Doe",
        "province": "ON",
        "credit_score": 750,
        "income_annual": 120000.00,
        "loan_amount": 450000.00,
        "property_value": 600000.00,
        "amortization_years": 25
    }

@pytest.fixture(scope="function")
def client(db_session):
    """
    Creates a FastAPI TestClient.
    We override the get_db dependency to use the test session.
    """
    # Import app here to avoid initialization issues during test collection
    # from main import app
    
    # Mocking the app for the purpose of this standalone test generation
    from fastapi import FastAPI
    app = FastAPI()
    
    # Mock dependency override
    def override_get_db():
        try:
            yield db_session
        finally:
            pass
    
    # app.dependency_overrides[get_db] = override_get_db
    # Note: In real code, uncomment the line above
    
    with TestClient(app) as test_client:
        yield test_client

@pytest.fixture(scope="function")
def env_vars_setup():
    """Sets up environment variables for configuration testing."""
    original_env = os.environ.copy()
    os.environ["DB_HOST"] = "localhost"
    os.environ["DB_PORT"] = "5432"
    os.environ["RISK_ENGINE_API_KEY"] = "secret-key"
    os.environ["ENVIRONMENT"] = "test"
    yield
    os.environ.clear()
    os.environ.update(original_env)
```

--- unit_tests ---
```python
import pytest
from unittest.mock import patch, MagicMock
import os
import sys

# Assuming the module handling deployment logic is named 'deployment_manager'
# from deployment_manager import (
#     load_environment_config,
#     check_database_connectivity,
#     check_external_dependencies,
#     perform_health_checks,
#     get_build_info
# )

# --- Mocking the module for standalone test execution ---
class DeploymentManager:
    @staticmethod
    def load_environment_config():
        config = {
            "db_host": os.getenv("DB_HOST"),
            "db_port": os.getenv("DB_PORT"),
            "api_key": os.getenv("RISK_ENGINE_API_KEY"),
            "env": os.getenv("ENVIRONMENT")
        }
        if not all(config.values()):
            raise ValueError("Missing required environment variables")
        return config

    @staticmethod
    def check_database_connectivity(db_engine):
        try:
            conn = db_engine.connect()
            conn.close()
            return True
        except Exception as e:
            return False

    @staticmethod
    def check_external_dependencies(redis_client, bureau_client):
        results = {}
        try:
            results["redis"] = redis_client.ping()
        except:
            results["redis"] = False
            
        try:
            results["credit_bureau"] = bureau_client.check_service_health()
        except:
            results["credit_bureau"] = False
            
        return results

    @staticmethod
    def perform_health_checks(db_status, deps_status):
        if not db_status:
            return {"status": "unhealthy", "reason": "Database connection failed"}
        if not all(deps_status.values()):
            return {"status": "unhealthy", "reason": "External dependency failed"}
        return {"status": "healthy", "uptime": "100h"}

    @staticmethod
    def get_build_info():
        return {
            "version": "1.2.3",
            "git_commit": "a1b2c3d",
            "build_date": "2023-10-27T10:00:00Z"
        }

# --- Unit Tests ---

class TestEnvironmentConfiguration:
    """Tests for loading and validating Docker environment variables."""

    def test_load_config_success(self, env_vars_setup):
        """Test successful loading of all required environment variables."""
        config = DeploymentManager.load_environment_config()
        
        assert config is not None
        assert config["db_host"] == "localhost"
        assert config["db_port"] == "5432"
        assert config["api_key"] == "secret-key"
        assert config["env"] == "test"

    def test_load_config_missing_variable(self, env_vars_setup):
        """Test handling of missing environment variables."""
        del os.environ["DB_HOST"]
        
        with pytest.raises(ValueError) as exc_info:
            DeploymentManager.load_environment_config()
        
        assert "Missing required environment variables" in str(exc_info.value)

    def test_load_config_empty_variable(self, env_vars_setup):
        """Test handling of empty environment variables."""
        os.environ["RISK_ENGINE_API_KEY"] = ""
        
        with pytest.raises(ValueError):
            DeploymentManager.load_environment_config()

    def test_config_types(self, env_vars_setup):
        """Test that configuration values are returned as strings."""
        config = DeploymentManager.load_environment_config()
        
        assert isinstance(config["db_port"], str)
        assert isinstance(config["api_key"], str)
        assert isinstance(config["env"], str)

    def test_config_isolation(self, env_vars_setup):
        """Test that config changes don't persist across calls (immutability check)."""
        config1 = DeploymentManager.load_environment_config()
        os.environ["DB_PORT"] = "3306"
        config2 = DeploymentManager.load_environment_config()
        
        assert config1["db_port"] == "5432"
        assert config2["db_port"] == "3306"


class TestConnectivityChecks:
    """Tests for checking database and external service connectivity."""

    def test_database_connection_success(self, db_engine):
        """Test successful database connection check."""
        result = DeploymentManager.check_database_connectivity(db_engine)
        assert result is True

    def test_database_connection_failure(self):
        """Test database connection check with a broken engine."""
        broken_engine = MagicMock()
        broken_engine.connect.side_effect = Exception("Connection refused")
        
        result = DeploymentManager.check_database_connectivity(broken_engine)
        assert result is False

    def test_redis_dependency_check_success(self, mock_redis_client):
        """Test successful Redis connectivity check."""
        mock_bureau = MagicMock()
        mock_bureau.check_service_health.return_value = True
        
        results = DeploymentManager.check_external_dependencies(mock_redis_client, mock_bureau)
        
        assert results["redis"] is True
        assert results["credit_bureau"] is True

    def test_redis_dependency_check_failure(self):
        """Test Redis connectivity check failure."""
        broken_redis = MagicMock()
        broken_redis.ping.side_effect = Exception("Redis timeout")
        mock_bureau = MagicMock()
        
        results = DeploymentManager.check_external_dependencies(broken_redis, mock_bureau)
        
        assert results["redis"] is False
        assert results["credit_bureau"] is True

    def test_bureau_dependency_check_failure(self, mock_redis_client):
        """Test Credit Bureau API connectivity check failure."""
        broken_bureau = MagicMock()
        broken_bureau.check_service_health.return_value = False
        
        results = DeploymentManager.check_external_dependencies(mock_redis_client, broken_bureau)
        
        assert results["redis"] is True
        assert results["credit_bureau"] is False

    def test_all_dependencies_down(self):
        """Test scenario where all external dependencies are down."""
        broken_redis = MagicMock()
        broken_redis.ping.side_effect = Exception()
        broken_bureau = MagicMock()
        broken_bureau.check_service_health.side_effect = Exception()
        
        results = DeploymentManager.check_external_dependencies(broken_redis, broken_bureau)
        
        assert results["redis"] is False
        assert results["credit_bureau"] is False


class TestHealthCheckLogic:
    """Tests for the core health check aggregation logic."""

    def test_health_check_all_good(self):
        """Test healthy status when all components are up."""
        db_status = True
        deps_status = {"redis": True, "credit_bureau": True}
        
        result = DeploymentManager.perform_health_checks(db_status, deps_status)
        
        assert result["status"] == "healthy"
        assert "uptime" in result
        assert "reason" not in result

    def test_health_check_db_down(self):
        """Test unhealthy status due to database failure."""
        db_status = False
        deps_status = {"redis": True, "credit_bureau": True}
        
        result = DeploymentManager.perform_health_checks(db_status, deps_status)
        
        assert result["status"] == "unhealthy"
        assert result["reason"] == "Database connection failed"

    def test_health_check_deps_down(self):
        """Test unhealthy status due to dependency failure."""
        db_status = True
        deps_status = {"redis": False, "credit_bureau": True}
        
        result = DeploymentManager.perform_health_checks(db_status, deps_status)
        
        assert result["status"] == "unhealthy"
        assert result["reason"] == "External dependency failed"

    def test_health_check_partial_deps_down(self):
        """Test unhealthy status when some (but not all) deps are down."""
        db_status = True
        deps_status = {"redis": True, "credit_bureau": False}
        
        result = DeploymentManager.perform_health_checks(db_status, deps_status)
        
        assert result["status"] == "unhealthy"

    def test_health_check_response_structure(self):
        """Test that the health check response returns the correct structure."""
        result = DeploymentManager.perform_health_checks(True, {"redis": True, "credit_bureau": True})
        
        assert isinstance(result, dict)
        assert "status" in result
        assert result["status"] in ["healthy", "unhealthy"]


class TestBuildInfo:
    """Tests for build versioning and metadata."""

    def test_get_build_info_content(self):
        """Test that build info returns expected keys."""
        info = DeploymentManager.get_build_info()
        
        assert "version" in info
        assert "git_commit" in info
        assert "build_date" in info

    def test_build_info_format(self):
        """Test format of build info strings."""
        info = DeploymentManager.get_build_info()
        
        assert len(info["git_commit"]) == 7 # Short hash
        assert "T" in info["build_date"] # ISO format
        assert "." in info["version"] # Semantic versioning

    def test_build_info_immutability(self):
        """Test that calling get_build_info twice returns same static data."""
        info1 = DeploymentManager.get_build_info()
        info2 = DeploymentManager.get_build_info()
        
        assert info1 == info2

# Total assertions check: ~28 assertions
```

--- integration_tests ---
```python
import pytest
from fastapi import FastAPI, HTTPException, status
from sqlalchemy.orm import Session

# --- Mocking the Application for Integration Testing ---
# In a real scenario, this code lives in main.py and routers/deployment.py

app = FastAPI()

@app.get("/health")
def health_check():
    # Simulated logic
    return {"status": "ok", "service": "mortgage-underwriting"}

@app.get("/ready")
def readiness_check():
    # Simulated logic checking DB/Cache
    return {"status": "ready", "checks": {"db": "up", "redis": "up"}}

@app.get("/info")
def app_info():
    return {"version": "1.0.0", "region": "ca-central-1"}

@app.post("/applications")
def submit_application(app_data: dict, db: Session = None):
    # Simulated endpoint
    if not app_data.get("applicant_name"):
        raise HTTPException(status_code=400, detail="Name required")
    return {"id": "APP-123", "status": "submitted", "province": app_data.get("province")}

# --- Integration Tests ---

class TestDeploymentEndpoints:
    """Tests for Docker/Deployment specific endpoints."""

    def test_health_liveness_endpoint(self, client):
        """Test the liveness probe endpoint used by Kubernetes/Docker."""
        response = client.get("/health")
        
        assert response.status_code == 200
        assert response.json()["status"] == "ok"
        assert "service" in response.json()
        assert response.json()["service"] == "mortgage-underwriting"

    def test_readiness_endpoint_database_status(self, client):
        """Test the readiness probe indicating database connectivity."""
        response = client.get("/ready")
        
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "ready"
        assert "checks" in data
        assert data["checks"]["db"] == "up"

    def test_readiness_endpoint_cache_status(self, client):
        """Test the readiness probe indicating cache connectivity."""
        response = client.get("/ready")
        
        assert response.status_code == 200
        data = response.json()
        assert data["checks"]["redis"] == "up"

    def test_info_endpoint_metadata(self, client):
        """Test the info endpoint for build and region metadata."""
        response = client.get("/info")
        
        assert response.status_code == 200
        data = response.json()
        assert "version" in data
        assert "region" in data
        assert data["region"] == "ca-central-1"

    def test_health_response_headers(self, client):
        """Test that health endpoints return correct content type."""
        response = client.get("/health")
        
        assert response.headers["content-type"] == "application/json"


class TestDeploymentWorkflow:
    """Multi-step workflows ensuring the deployed system is functional."""

    def test_full_system_startup_workflow(self, client, sample_mortgage_payload):
        """
        Workflow:
        1. Check Health (Is container running?)
        2. Check Readiness (Is DB connected?)
        3. Submit Application (Can we process a request?)
        """
        # Step 1: Liveness
        health_resp = client.get("/health")
        assert health_resp.status_code == 200
        
        # Step 2: Readiness
        ready_resp = client.get("/ready")
        assert ready_resp.status_code == 200
        
        # Step 3: Functional Request (Submit Mortgage)
        app_resp = client.post("/applications", json=sample_mortgage_payload)
        assert app_resp.status_code == 200
        assert app_resp.json()["status"] == "submitted"
        assert app_resp.json()["province"] == "ON"

    def test_system_resilience_after_bad_request(self, client):
        """
        Workflow:
        1. Send invalid data.
        2. Verify system handles error gracefully (doesn't crash).
        3. Send valid data to ensure system is still processing.
        """
        # Step 1: Invalid Request
        bad_payload = {"applicant_name": ""} # Missing required fields
        bad_resp = client.post("/applications", json=bad_payload)
        assert bad_resp.status_code == 400
        
        # Step 2: Verify Health is still OK (Container didn't crash)
        health_resp = client.get("/health")
        assert health_resp.status_code == 200
        
        # Step 3: Verify Valid Request still works
        good_payload = {
            "applicant_name": "Jane Smith",
            "province": "BC",
            "loan_amount": 500000
        }
        good_resp = client.post("/applications", json=good_payload)
        assert good_resp.status_code == 200

    def test_concurrent_health_checks(self, client):
        """Test that health checks handle rapid requests (Docker startup storms)."""
        responses = []
        for _ in range(10):
            resp = client.get("/health")
            responses.append(resp.status_code)
        
        # All requests should succeed
        assert all(status == 200 for status in responses)

    def test_region_specific_deployment_config(self, client):
        """Test that deployment config reflects Canadian region settings."""
        info = client.get("/info").json()
        
        # Verify specific Canadian deployment context
        assert info["region"] == "ca-central-1"
        # Ensure version is present
        assert info["version"] is not None

# Total assertions check: ~20 assertions
```